{% extends "base.html" %}

{% block title %}Dashboard - Solar Sync{% endblock %}

{% block content %}
<div class="dashboard-page">
    <div class="dashboard-container">
        <!-- Hardware Status Banner -->
        <div class="status-banner">
            <div class="hardware-info">
                <div class="hardware-status" id="hardware-status">
                    <i class="fas fa-microchip"></i>
                    <span id="status-text">Checking hardware...</span>
                </div>
                <div class="device-info" id="device-info">
                    <i class="fas fa-plug"></i>
                    <span id="device-text">No devices connected</span>
                </div>
            </div>
            <div class="real-time-indicator-container">
                <span class="real-time-indicator"></span>
                <span>Real-time data</span>
            </div>
        </div>

        <!-- Power Flow Grid -->
        <div class="power-flow-grid">
            <!-- Solar Power -->
            <div class="power-card solar">
                <div class="power-icon">
                    <i class="fas fa-solar-panel"></i>
                </div>
                <div class="power-label">Solar Power</div>
                <div class="power-value" id="solar-power">--</div>
                <div class="power-unit">Watts</div>
                <div class="power-trend" id="solar-trend">
                    <i class="fas fa-minus"></i> Stable
                </div>
            </div>

            <!-- Battery Power -->
            <div class="power-card battery">
                <div class="power-icon">
                    <i class="fas fa-battery-three-quarters"></i>
                </div>
                <div class="power-label">Battery Power</div>
                <div class="power-value" id="battery-power">--</div>
                <div class="power-unit">Watts</div>
                <div class="power-trend" id="battery-trend">
                    <i class="fas fa-minus"></i> Stable
                </div>
            </div>

            <!-- Load Power -->
            <div class="power-card load">
                <div class="power-icon">
                    <i class="fas fa-home"></i>
                </div>
                <div class="power-label">Load Power</div>
                <div class="power-value" id="load-power">--</div>
                <div class="power-unit">Watts</div>
                <div class="power-trend" id="load-trend">
                    <i class="fas fa-minus"></i> Stable
                </div>
            </div>

            <!-- Grid Power -->
            <div class="power-card grid">
                <div class="power-icon">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="power-label">Grid Power</div>
                <div class="power-value" id="grid-power">--</div>
                <div class="power-unit">Watts</div>
                <div class="power-trend" id="grid-trend">
                    <i class="fas fa-minus"></i> Stable
                </div>
            </div>
        </div>

        <!-- System Statistics -->
        <div class="system-stats">
            <!-- Battery Status -->
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-battery-half"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Battery Status</div>
                    <div class="stat-value" id="battery-soc">--%</div>
                </div>
            </div>

            <!-- System Efficiency -->
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">System Efficiency</div>
                    <div class="stat-value" id="system-efficiency">--%</div>
                </div>
            </div>

            <!-- Temperature -->
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-thermometer-half"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Temperature</div>
                    <div class="stat-value" id="temperature">--°C</div>
                </div>
            </div>

            <!-- Battery Voltage -->
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Battery Voltage</div>
                    <div class="stat-value" id="battery-voltage">--V</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Store previous values for trend calculation
let previousValues = {
    solar: 0,
    battery: 0,
    load: 0,
    grid: 0
};

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadHardwareStatus();
    loadCurrentData();
    
    // Set up periodic updates
    setInterval(loadCurrentData, 5000);
    setInterval(loadHardwareStatus, 10000);
});

async function loadHardwareStatus() {
    try {
        const response = await fetch('/api/hardware/status');
        const result = await response.json();
        
        if (result.status === 'success') {
            updateHardwareStatus(result.data);
        }
    } catch (error) {
        console.error('Error loading hardware status:', error);
    }
}

function updateHardwareStatus(status) {
    const statusElement = document.getElementById('hardware-status');
    const statusText = document.getElementById('status-text');
    const deviceText = document.getElementById('device-text');
    
    // Update status
    statusElement.className = 'hardware-status';
    if (status.simulation_mode) {
        statusElement.classList.add('simulation');
        statusText.textContent = 'Simulation Mode';
    } else if (status.connected_devices > 0) {
        statusElement.classList.add('real-devices');
        statusText.textContent = `${status.connected_devices} Device(s) Connected`;
    } else {
        statusElement.classList.add('error');
        statusText.textContent = 'No Devices Connected';
    }
    
    // Update device info
    if (status.total_devices > 0) {
        const deviceList = Object.values(status.devices).map(d => d.name).join(', ');
        deviceText.textContent = deviceList;
    } else {
        deviceText.textContent = 'No devices detected';
    }
}

async function loadCurrentData() {
    try {
        const response = await fetch('/api/hardware/data/latest');
        const result = await response.json();
        
        if (result.status === 'success') {
            updateDashboard(result.data);
        }
    } catch (error) {
        console.error('Error loading current data:', error);
    }
}

function updateDashboard(data) {
    // Update power values
    updatePowerValue('solar-power', data.solar_power_w, 'W');
    updatePowerValue('battery-power', data.battery_power_w, 'W');
    updatePowerValue('load-power', data.load_power_w, 'W');
    updatePowerValue('grid-power', data.grid_power_w, 'W');
    
    // Update system stats
    document.getElementById('battery-soc').textContent = `${data.battery_soc_percent.toFixed(1)}%`;
    document.getElementById('system-efficiency').textContent = `${data.system_efficiency_percent.toFixed(1)}%`;
    document.getElementById('temperature').textContent = `${data.temperature_c.toFixed(1)}°C`;
    document.getElementById('battery-voltage').textContent = `${data.battery_voltage_v.toFixed(1)}V`;
    
    // Update trends
    updateTrend('solar-trend', data.solar_power_w, previousValues.solar);
    updateTrend('battery-trend', data.battery_power_w, previousValues.battery);
    updateTrend('load-trend', data.load_power_w, previousValues.load);
    updateTrend('grid-trend', data.grid_power_w, previousValues.grid);
    
    // Store current values for next comparison
    previousValues = {
        solar: data.solar_power_w,
        battery: data.battery_power_w,
        load: data.load_power_w,
        grid: data.grid_power_w
    };
}

function updatePowerValue(elementId, value, unit) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = value.toFixed(0);
    }
}

function updateTrend(elementId, currentValue, previousValue) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const diff = currentValue - previousValue;
    const icon = element.querySelector('i');
    const text = element.querySelector('span') || element;
    
    if (Math.abs(diff) < 10) {
        // Stable
        icon.className = 'fas fa-minus';
        text.textContent = ' Stable';
        element.className = 'power-trend trend-stable';
    } else if (diff > 0) {
        // Increasing
        icon.className = 'fas fa-arrow-up';
        text.textContent = ' Increasing';
        element.className = 'power-trend trend-up';
    } else {
        // Decreasing
        icon.className = 'fas fa-arrow-down';
        text.textContent = ' Decreasing';
        element.className = 'power-trend trend-down';
    }
}
</script>
{% endblock %}
