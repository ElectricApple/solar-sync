{% extends "base.html" %}

{% block title %}Dashboard - Solar Sync{% endblock %}

{% block extra_css %}
<style>
.dashboard-container {
    padding: var(--spacing-xl);
    max-width: 1400px;
    margin: 0 auto;
}

.status-banner {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--spacing-md);
}

.hardware-status {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-md);
    font-weight: 500;
    font-size: 0.875rem;
}

.hardware-status.simulation {
    background: var(--warning-orange);
    color: var(--black);
}

.hardware-status.real-devices {
    background: var(--success-green);
    color: var(--white);
}

.hardware-status.error {
    background: var(--danger-red);
    color: var(--white);
}

.device-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.device-info i {
    color: var(--primary-yellow);
}

.power-flow-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--spacing-xl);
    margin-bottom: var(--spacing-2xl);
}

.power-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    text-align: center;
    box-shadow: var(--shadow-sm);
    transition: all 0.2s ease;
}

.power-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.power-card.solar {
    border-left: 4px solid var(--primary-yellow);
}

.power-card.battery {
    border-left: 4px solid var(--success-green);
}

.power-card.load {
    border-left: 4px solid var(--info-blue);
}

.power-card.grid {
    border-left: 4px solid var(--gray);
}

.power-icon {
    font-size: 2rem;
    margin-bottom: var(--spacing-md);
}

.power-card.solar .power-icon {
    color: var(--primary-yellow);
}

.power-card.battery .power-icon {
    color: var(--success-green);
}

.power-card.load .power-icon {
    color: var(--info-blue);
}

.power-card.grid .power-icon {
    color: var(--gray);
}

.power-value {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: var(--spacing-sm);
}

.power-unit {
    font-size: 0.875rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.power-label {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--spacing-sm);
}

.power-trend {
    font-size: 0.875rem;
    margin-top: var(--spacing-sm);
}

.trend-up {
    color: var(--success-green);
}

.trend-down {
    color: var(--danger-red);
}

.trend-stable {
    color: var(--text-secondary);
}

.system-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-2xl);
}

.stat-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    box-shadow: var(--shadow-sm);
}

.stat-icon {
    font-size: 1.5rem;
    color: var(--primary-yellow);
    width: 40px;
    text-align: center;
}

.stat-content {
    flex: 1;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: var(--spacing-xs);
}

.stat-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
}

.real-time-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    background: var(--success-green);
    border-radius: 50%;
    margin-right: var(--spacing-sm);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: var(--spacing-lg);
    }
    
    .status-banner {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
    }
    
    .power-flow-grid {
        grid-template-columns: 1fr;
    }
    
    .system-stats {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Hardware Status Banner -->
    <div class="status-banner">
        <div class="hardware-info">
            <div class="hardware-status" id="hardware-status">
                <i class="fas fa-microchip"></i>
                <span id="status-text">Checking hardware...</span>
            </div>
            <div class="device-info" id="device-info">
                <i class="fas fa-plug"></i>
                <span id="device-text">No devices connected</span>
            </div>
        </div>
        <div class="real-time-indicator-container">
            <span class="real-time-indicator"></span>
            <span>Real-time data</span>
        </div>
    </div>

    <!-- Power Flow Grid -->
    <div class="power-flow-grid">
        <!-- Solar Power -->
        <div class="power-card solar">
            <div class="power-icon">
                <i class="fas fa-solar-panel"></i>
            </div>
            <div class="power-label">Solar Power</div>
            <div class="power-value" id="solar-power">--</div>
            <div class="power-unit">Watts</div>
            <div class="power-trend" id="solar-trend">
                <i class="fas fa-minus"></i> Stable
            </div>
        </div>

        <!-- Battery Power -->
        <div class="power-card battery">
            <div class="power-icon">
                <i class="fas fa-battery-three-quarters"></i>
            </div>
            <div class="power-label">Battery Power</div>
            <div class="power-value" id="battery-power">--</div>
            <div class="power-unit">Watts</div>
            <div class="power-trend" id="battery-trend">
                <i class="fas fa-minus"></i> Stable
            </div>
        </div>

        <!-- Load Power -->
        <div class="power-card load">
            <div class="power-icon">
                <i class="fas fa-home"></i>
            </div>
            <div class="power-label">Load Power</div>
            <div class="power-value" id="load-power">--</div>
            <div class="power-unit">Watts</div>
            <div class="power-trend" id="load-trend">
                <i class="fas fa-minus"></i> Stable
            </div>
        </div>

        <!-- Grid Power -->
        <div class="power-card grid">
            <div class="power-icon">
                <i class="fas fa-bolt"></i>
            </div>
            <div class="power-label">Grid Power</div>
            <div class="power-value" id="grid-power">--</div>
            <div class="power-unit">Watts</div>
            <div class="power-trend" id="grid-trend">
                <i class="fas fa-minus"></i> Stable
            </div>
        </div>
    </div>

    <!-- System Statistics -->
    <div class="system-stats">
        <!-- Battery Status -->
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-battery-half"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Battery Status</div>
                <div class="stat-value" id="battery-soc">--%</div>
            </div>
        </div>

        <!-- System Efficiency -->
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">System Efficiency</div>
                <div class="stat-value" id="system-efficiency">--%</div>
            </div>
        </div>

        <!-- Temperature -->
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-thermometer-half"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Temperature</div>
                <div class="stat-value" id="temperature">--Â°C</div>
            </div>
        </div>

        <!-- Battery Voltage -->
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-bolt"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Battery Voltage</div>
                <div class="stat-value" id="battery-voltage">--V</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// WebSocket connection for real-time updates
let ws = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;

// Previous values for trend calculation
let previousValues = {
    solar: 0,
    battery: 0,
    load: 0,
    grid: 0
};

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeWebSocket();
    loadHardwareStatus();
    loadCurrentData();
    
    // Refresh data every 5 seconds
    setInterval(loadCurrentData, 5000);
    setInterval(loadHardwareStatus, 10000);
});

function initializeWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/dashboard/ws`;
    
    ws = new WebSocket(wsUrl);
    
    ws.onopen = function() {
        console.log('WebSocket connected');
        reconnectAttempts = 0;
    };
    
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        updateDashboard(data);
    };
    
    ws.onclose = function() {
        console.log('WebSocket disconnected');
        if (reconnectAttempts < maxReconnectAttempts) {
            setTimeout(initializeWebSocket, 5000);
            reconnectAttempts++;
        }
    };
    
    ws.onerror = function(error) {
        console.error('WebSocket error:', error);
    };
}

async function loadHardwareStatus() {
    try {
        const response = await fetch('/api/hardware/status');
        const result = await response.json();
        
        if (result.status === 'success') {
            updateHardwareStatus(result.data);
        }
    } catch (error) {
        console.error('Error loading hardware status:', error);
    }
}

function updateHardwareStatus(status) {
    const statusElement = document.getElementById('hardware-status');
    const statusText = document.getElementById('status-text');
    const deviceElement = document.getElementById('device-info');
    const deviceText = document.getElementById('device-text');
    
    // Update status
    statusElement.className = 'hardware-status';
    if (status.simulation_mode) {
        statusElement.classList.add('simulation');
        statusText.textContent = 'Simulation Mode';
    } else if (status.connected_devices > 0) {
        statusElement.classList.add('real-devices');
        statusText.textContent = `${status.connected_devices} Device(s) Connected`;
    } else {
        statusElement.classList.add('error');
        statusText.textContent = 'No Devices Connected';
    }
    
    // Update device info
    if (status.total_devices > 0) {
        const deviceList = Object.values(status.devices).map(d => d.name).join(', ');
        deviceText.textContent = deviceList;
    } else {
        deviceText.textContent = 'No devices detected';
    }
}

async function loadCurrentData() {
    try {
        const response = await fetch('/api/hardware/data/latest');
        const result = await response.json();
        
        if (result.status === 'success') {
            updateDashboard(result.data);
        }
    } catch (error) {
        console.error('Error loading current data:', error);
    }
}

function updateDashboard(data) {
    // Update power values
    updatePowerValue('solar-power', data.solar_power_w, 'W');
    updatePowerValue('battery-power', data.battery_power_w, 'W');
    updatePowerValue('load-power', data.load_power_w, 'W');
    updatePowerValue('grid-power', data.grid_power_w, 'W');
    
    // Update system stats
    document.getElementById('battery-soc').textContent = `${data.battery_soc_percent.toFixed(1)}%`;
    document.getElementById('system-efficiency').textContent = `${data.system_efficiency_percent.toFixed(1)}%`;
    document.getElementById('temperature').textContent = `${data.temperature_c.toFixed(1)}Â°C`;
    document.getElementById('battery-voltage').textContent = `${data.battery_voltage_v.toFixed(1)}V`;
    
    // Update trends
    updateTrend('solar-trend', data.solar_power_w, previousValues.solar);
    updateTrend('battery-trend', data.battery_power_w, previousValues.battery);
    updateTrend('load-trend', data.load_power_w, previousValues.load);
    updateTrend('grid-trend', data.grid_power_w, previousValues.grid);
    
    // Store current values for next comparison
    previousValues = {
        solar: data.solar_power_w,
        battery: data.battery_power_w,
        load: data.load_power_w,
        grid: data.grid_power_w
    };
}

function updatePowerValue(elementId, value, unit) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = value.toFixed(0);
    }
}

function updateTrend(elementId, currentValue, previousValue) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const diff = currentValue - previousValue;
    const icon = element.querySelector('i');
    const text = element.querySelector('span') || element;
    
    if (Math.abs(diff) < 10) {
        // Stable
        icon.className = 'fas fa-minus';
        text.textContent = ' Stable';
        element.className = 'power-trend trend-stable';
    } else if (diff > 0) {
        // Increasing
        icon.className = 'fas fa-arrow-up';
        text.textContent = ' Increasing';
        element.className = 'power-trend trend-up';
    } else {
        // Decreasing
        icon.className = 'fas fa-arrow-down';
        text.textContent = ' Decreasing';
        element.className = 'power-trend trend-down';
    }
}
</script>
{% endblock %}
